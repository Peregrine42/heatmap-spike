<html>
  <head>
    <style>
      .pi-dot {
        stroke: white;
        stroke-width: 2;
      }
      .subunit {
        stroke: gray;
        stroke-width: 1;
    </style>
  </head>
  <body>
    <div id="container" style="background-color: white; position: relative; width: 1000; height: 600;"></div>
  </body>
  <script src="d3.js"></script>
  <script src="topojson.js"></script>
  <script src="datamaps.all.js"></script>
  <script src="jquery.min.js"></script>
  <script src="velocity.min.js"></script>
  <script>
    function arcTween(a) {
      var i = d3.interpolate(this._current, a);
      this._current = i(0);
      return function(t) {
        return arc(i(t));
      };
    }
    function make_element(id, lon, lat) {
      var lon = parseFloat(lon);
      var lat = parseFloat(lat);

      var group = svg.append('g')
        .attr(
          'transform',
          'translate(' + projection([lon, lat]) + ')')
        .attr('id', id)
        .attr('class', 'pi-dot');

      var data = [0.0001]
      group.datum(data).selectAll('path')
        .data(pie)
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', function(d, i) {
          return (i % 2) ? "red" : "blue"
        })
        .each(function(d) { this._current = d; });
    }

    function handle_message(data) {
      var msg = $.parseJSON(data);
      msg.events.forEach(function(item) {
        if (item.lon != NaN && item.lat != NaN && item.lon != undefined && item.lat != undefined) {
          d3.select("#" + item.id).remove();
          make_element(item.id, item.lon, item.lat);
        }

        var value = parseFloat(item.value);
        var data = [value];
        path = svg.datum(data)
          .select('#' + item.id)
          .selectAll('path')
          .data(pie);
        path.transition()
          .delay(function(d, i) { return 500 * i })
          .duration(500)
          .attrTween("d", arcTween);
      })
    };

    function handle_server_event(e) {
      handle_message(e.data);
    };

    var width = $(window).width();
    var height = 1200;
    $("#container").width(width);
    $("#container").height(height);

    var highlight = "#FF0000";
    var lowlight = "#895CCD";
    var normal = "#333333";

    var color = d3.scale.linear()
      .domain([-1, 0, 1])
      .range([lowlight, normal, highlight]);

    pie = d3.layout.pie()
      .startAngle(-90 * (Math.PI/180))
      .endAngle(90 * (Math.PI/180))

    arc = d3.svg.arc()
      .outerRadius(20)

    d3.json("uk_areas.json", function(error, uk) {
      if (error) return console.error(error);

      svg = d3.select("#container").append("svg")
        .attr("width", width)
        .attr("height", height);

      projection = d3.geo.albers()
        .center([0, 55.4])
        .rotate([4.4, 0])
        .parallels([50, 60])
        .scale(6000)
        .translate([width / 2, height / 2]);

      var path = d3.geo.path()
        .projection(projection);

      svg.selectAll(".subunit")
        .data(topojson.feature(uk, uk.objects.output).features)
        .enter().append("path")
        .attr("fill", normal)
        .attr("class", function(d) {
          name = "";
          if (d.properties.name) {
            name = d.properties.name.replace(" ", "_")
          }
          return "subunit " + name;
        })
        .attr("d", path);

      $.get('/initial', handle_message);
    });
    var es = new EventSource('/connect');
    es.onmessage = handle_server_event;

  </script>
</html>
